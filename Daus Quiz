<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daus Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      overflow: hidden;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .neon-glow {
      box-shadow: 0 0 20px currentColor, 0 0 40px currentColor, 0 0 60px currentColor;
    }
    
    .neon-border {
      box-shadow: 0 0 10px currentColor, 0 0 20px currentColor, inset 0 0 10px rgba(255, 255, 255, 0.1);
    }
    
    .glass-effect {
      backdrop-filter: blur(12px);
      background: rgba(0, 0, 0, 0.4);
    }
    
    .focus-ring:focus-visible {
      outline: 3px solid rgba(139, 92, 246, 0.6);
      outline-offset: 2px;
    }
    
    .emoji-selector {
      cursor: pointer;
      transition: all 0.2s;
      display: inline-block;
    }
    
    .emoji-selector:hover {
      transform: scale(1.15);
    }
    
    .emoji-selector.active {
      transform: scale(1.25);
      filter: drop-shadow(0 0 10px rgba(168, 85, 247, 0.8));
    }
    
    .scroll-container {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .scroll-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .scroll-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    
    .scroll-container::-webkit-scrollbar-thumb {
      background: rgba(168, 85, 247, 0.5);
      border-radius: 4px;
    }
    
    .scroll-container::-webkit-scrollbar-thumb:hover {
      background: rgba(168, 85, 247, 0.7);
    }
    
    .profile-photo-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(168, 85, 247, 0.6);
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
    }
    
    .profile-photo-display {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(236, 72, 153, 0.6);
      box-shadow: 0 0 20px rgba(236, 72, 153, 0.6);
    }
    
    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
      }
      50% {
        box-shadow: 0 0 30px currentColor, 0 0 60px currentColor, 0 0 80px currentColor;
      }
    }
    
    .animate-pulse-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #a855f7, #ec4899, #f59e0b, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal-content {
      max-width: 500px;
      width: 100%;
      border-radius: 16px;
      padding: 24px;
    }
  </style>
  <script>
    // ===== CONFIG =====
    const defaultConfig = {
      background_color: "#0f0a1e",
      surface_color: "#1a1333",
      text_color: "#ffffff",
      primary_action_color: "#a855f7",
      secondary_action_color: "#ec4899",
      
      font_family: "Inter",
      font_size: 16,
      
      app_title: "Daus Quiz",
      welcome_message: "Tantang dirimu dengan pertanyaan seru dan raih skor tertinggi!",
      start_quiz_button: "Mulai Quiz",
      question_label: "Pertanyaan",
      result_header: "Hasil Quiz Kamu",
      retry_text: "Main Lagi",
      footer_note: "Selamat bermain dan semoga berhasil!"
    };
    
    // ===== STATE =====
    let uiElements = {};
    let allUsers = [];
    let currentUser = null;
    let currentView = "welcome"; // welcome, register, login, profile, edit-profile, edit-username, quiz-setup, quiz, result, review
    let selectedDifficulty = "medium";
    let quizData = [];
    let currentQuestionIndex = 0;
    let userScore = 0;
    let userAnswers = [];
    let showHintModal = false;
    
    // ===== QUIZ QUESTIONS =====
    const questionBank = {
      easy: [
        {
          id: "e1",
          text: "Berapa hasil dari 10 + 5?",
          choices: ["12", "15", "20", "25"],
          correct: 1,
          hint: "Jumlahkan 10 dengan 5"
        },
        {
          id: "e2",
          text: "Apa ibu kota Indonesia?",
          choices: ["Bandung", "Jakarta", "Surabaya", "Medan"],
          correct: 1,
          hint: "Kota terbesar di Indonesia"
        },
        {
          id: "e3",
          text: "Warna daun pada umumnya adalah?",
          choices: ["Merah", "Hijau", "Biru", "Kuning"],
          correct: 1,
          hint: "Warna yang sama dengan rumput"
        },
        {
          id: "e4",
          text: "Hewan yang bisa terbang adalah?",
          choices: ["Kucing", "Anjing", "Burung", "Ikan"],
          correct: 2,
          hint: "Hewan yang memiliki sayap"
        },
        {
          id: "e5",
          text: "Berapa jumlah hari dalam seminggu?",
          choices: ["5", "6", "7", "8"],
          correct: 2,
          hint: "Senin sampai Minggu"
        }
      ],
      medium: [
        {
          id: "m1",
          text: "Hasil dari 12 x 8 adalah?",
          choices: ["84", "96", "104", "112"],
          correct: 1,
          hint: "Kalikan 12 dengan 8"
        },
        {
          id: "m2",
          text: "Planet terbesar di tata surya adalah?",
          choices: ["Mars", "Bumi", "Jupiter", "Saturnus"],
          correct: 2,
          hint: "Planet gas raksasa dengan bintik merah"
        },
        {
          id: "m3",
          text: "Siapa penemu lampu pijar?",
          choices: ["Albert Einstein", "Thomas Edison", "Nikola Tesla", "Isaac Newton"],
          correct: 1,
          hint: "Penemu Amerika yang terkenal"
        },
        {
          id: "m4",
          text: "Rumus kimia air adalah?",
          choices: ["H2O", "CO2", "O2", "NaCl"],
          correct: 0,
          hint: "Terdiri dari hidrogen dan oksigen"
        },
        {
          id: "m5",
          text: "Bahasa pemrograman untuk web adalah?",
          choices: ["Python", "JavaScript", "C++", "Java"],
          correct: 1,
          hint: "Berjalan di browser"
        },
        {
          id: "m6",
          text: "Tahun kemerdekaan Indonesia?",
          choices: ["1942", "1945", "1950", "1965"],
          correct: 1,
          hint: "17 Agustus tahun ini"
        }
      ],
      hard: [
        {
          id: "h1",
          text: "Hasil dari 156 x 17 adalah?",
          choices: ["2642", "2652", "2662", "2672"],
          correct: 1,
          hint: "Antara 2600-2700"
        },
        {
          id: "h2",
          text: "Siapa yang menemukan teori relativitas?",
          choices: ["Isaac Newton", "Albert Einstein", "Stephen Hawking", "Galileo"],
          correct: 1,
          hint: "Fisikawan Jerman terkenal"
        },
        {
          id: "h3",
          text: "Bahasa pemrograman yang dibuat oleh Guido van Rossum?",
          choices: ["Ruby", "Python", "PHP", "Perl"],
          correct: 1,
          hint: "Namanya diambil dari nama ular"
        },
        {
          id: "h4",
          text: "Jumlah kromosom manusia normal adalah?",
          choices: ["23", "44", "46", "48"],
          correct: 2,
          hint: "23 pasang kromosom"
        },
        {
          id: "h5",
          text: "Protokol transfer file di internet adalah?",
          choices: ["HTTP", "FTP", "SMTP", "DNS"],
          correct: 1,
          hint: "File Transfer Protocol"
        },
        {
          id: "h6",
          text: "Satuan gaya dalam SI adalah?",
          choices: ["Joule", "Watt", "Newton", "Pascal"],
          correct: 2,
          hint: "Dinamai dari fisikawan Inggris"
        },
        {
          id: "h7",
          text: "Kecepatan cahaya dalam vakum adalah?",
          choices: ["300.000 km/s", "150.000 km/s", "450.000 km/s", "600.000 km/s"],
          correct: 0,
          hint: "Sekitar 3 x 10^8 m/s"
        }
      ]
    };
    
    // ===== ELEMENT SDK =====
    async function initElementSdk() {
      if (!window.elementSdk) return;
      
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          const cfg = { ...defaultConfig, ...config };
          const root = uiElements.root;
          if (!root) return;
          
          const fontStack = `${cfg.font_family}, system-ui, -apple-system, sans-serif`;
          const baseSize = cfg.font_size;
          
          // Colors
          const bg = cfg.background_color;
          const surface = cfg.surface_color;
          const text = cfg.text_color;
          const primary = cfg.primary_action_color;
          const secondary = cfg.secondary_action_color;
          
          // Apply background
          root.style.background = `
            radial-gradient(circle at 20% 30%, ${primary}40, transparent 50%),
            radial-gradient(circle at 80% 70%, ${secondary}40, transparent 50%),
            linear-gradient(135deg, ${bg}, #000000)
          `;
          
          // Apply to card
          if (uiElements.card) {
            uiElements.card.style.backgroundColor = surface;
            uiElements.card.style.color = text;
            uiElements.card.style.borderColor = primary;
            uiElements.card.style.fontFamily = fontStack;
          }
          
          // Apply to all inputs
          document.querySelectorAll('input, textarea').forEach(input => {
            input.style.fontFamily = fontStack;
            input.style.fontSize = baseSize + 'px';
            input.style.color = text;
            input.style.backgroundColor = surface;
            input.style.borderColor = secondary;
          });
          
          // Apply to all buttons
          document.querySelectorAll('button').forEach(btn => {
            btn.style.fontFamily = fontStack;
            btn.style.fontSize = baseSize + 'px';
            
            if (btn.classList.contains('btn-primary')) {
              btn.style.backgroundColor = primary;
              btn.style.borderColor = primary;
              btn.style.color = '#ffffff';
            } else if (btn.classList.contains('btn-secondary')) {
              btn.style.backgroundColor = secondary;
              btn.style.borderColor = secondary;
              btn.style.color = '#ffffff';
            } else if (btn.classList.contains('difficulty-active')) {
              btn.style.backgroundColor = primary;
              btn.style.borderColor = primary;
              btn.style.color = '#ffffff';
            } else {
              btn.style.color = text;
              btn.style.borderColor = secondary + '80';
              btn.style.backgroundColor = 'transparent';
            }
          });
          
          // Apply to labels
          document.querySelectorAll('label').forEach(label => {
            label.style.fontFamily = fontStack;
            label.style.fontSize = (baseSize * 0.9) + 'px';
            label.style.color = text;
          });
          
          // Apply to text elements
          if (uiElements.footer) {
            uiElements.footer.style.fontFamily = fontStack;
            uiElements.footer.style.fontSize = (baseSize * 0.85) + 'px';
            uiElements.footer.style.color = text + 'cc';
          }
        },
        mapToCapabilities: (config) => {
          const cfg = { ...defaultConfig, ...config };
          
          return {
            recolorables: [
              {
                get: () => cfg.background_color,
                set: (val) => window.elementSdk.setConfig({ background_color: val })
              },
              {
                get: () => cfg.surface_color,
                set: (val) => window.elementSdk.setConfig({ surface_color: val })
              },
              {
                get: () => cfg.text_color,
                set: (val) => window.elementSdk.setConfig({ text_color: val })
              },
              {
                get: () => cfg.primary_action_color,
                set: (val) => window.elementSdk.setConfig({ primary_action_color: val })
              },
              {
                get: () => cfg.secondary_action_color,
                set: (val) => window.elementSdk.setConfig({ secondary_action_color: val })
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => cfg.font_family,
              set: (val) => window.elementSdk.setConfig({ font_family: val })
            },
            fontSizeable: {
              get: () => cfg.font_size,
              set: (val) => window.elementSdk.setConfig({ font_size: val })
            }
          };
        },
        mapToEditPanelValues: (config) => {
          const cfg = { ...defaultConfig, ...config };
          return new Map([
            ['app_title', cfg.app_title],
            ['welcome_message', cfg.welcome_message],
            ['start_quiz_button', cfg.start_quiz_button],
            ['question_label', cfg.question_label],
            ['result_header', cfg.result_header],
            ['retry_text', cfg.retry_text],
            ['footer_note', cfg.footer_note]
          ]);
        }
      });
    }
    
    // ===== DATA SDK =====
    const dataHandler = {
      onDataChanged(data) {
        allUsers = data;
        renderView();
      }
    };
    
    async function initDataSdk() {
      if (!window.dataSdk) return;
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        console.error('Data SDK init failed');
      }
    }
    
    // ===== HELPERS =====
    function validateUsername(username) {
      return /^[a-zA-Z0-9_]{3,20}$/.test(username);
    }
    
    function isUsernameTaken(username) {
      return allUsers.some(u => u.username.toLowerCase() === username.toLowerCase());
    }
    
    function shuffleArray(arr) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }
    
    function pickQuestions(difficulty, count) {
      const pool = questionBank[difficulty] || questionBank.medium;
      return shuffleArray(pool).slice(0, Math.min(count, pool.length));
    }
    
    function showInlineError(id, message) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = message;
        el.classList.remove('hidden');
      }
    }
    
    // ===== ACTIONS =====
    function changeView(view) {
      currentView = view;
      renderView();
    }
    
    function selectDifficulty(level) {
      selectedDifficulty = level;
      renderView();
    }
    
    function selectEmoji(el) {
      document.querySelectorAll('.emoji-selector').forEach(e => e.classList.remove('active'));
      el.classList.add('active');
    }
    
    function handlePhotoUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        showInlineError('reg-error', 'File harus berupa gambar');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const preview = document.getElementById('photo-preview');
        if (preview) {
          preview.src = event.target.result;
          preview.style.display = 'block';
        }
      };
      reader.readAsDataURL(file);
    }
    
    function handleEditPhotoUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        showInlineError('edit-error', 'File harus berupa gambar');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const preview = document.getElementById('edit-photo-preview');
        if (preview) {
          preview.src = event.target.result;
          preview.style.display = 'block';
        }
      };
      reader.readAsDataURL(file);
    }
    
    function togglePassword(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'üôà';
      } else {
        input.type = 'password';
        icon.textContent = 'üëÅÔ∏è';
      }
    }
    
    function openHint() {
      showHintModal = true;
      renderView();
    }
    
    function closeHint() {
      showHintModal = false;
      renderView();
    }
    
    async function handleRegister(e) {
      e.preventDefault();
      
      const fullName = document.getElementById('reg-name').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const bio = document.getElementById('reg-bio').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPass = document.getElementById('reg-confirm').value;
      const selectedEmoji = document.querySelector('.emoji-selector.active');
      const errorEl = document.getElementById('reg-error');
      
      errorEl.textContent = '';
      errorEl.classList.add('hidden');
      
      if (!fullName || !username || !password) {
        showInlineError('reg-error', 'Nama, username, dan password wajib diisi');
        return;
      }
      
      if (!validateUsername(username)) {
        showInlineError('reg-error', 'Username harus 3-20 karakter (huruf, angka, underscore)');
        return;
      }
      
      if (isUsernameTaken(username)) {
        showInlineError('reg-error', 'Username sudah digunakan');
        return;
      }
      
      if (password.length < 6) {
        showInlineError('reg-error', 'Password minimal 6 karakter');
        return;
      }
      
      if (password !== confirmPass) {
        showInlineError('reg-error', 'Password tidak cocok');
        return;
      }
      
      const customEmoji = document.getElementById('reg-custom-emoji').value.trim();
      const emoji = customEmoji || (selectedEmoji ? selectedEmoji.textContent : 'üòä');
      const photoPreview = document.getElementById('photo-preview');
      const profilePhoto = photoPreview && photoPreview.src && photoPreview.src.startsWith('data:') ? photoPreview.src : '';
      
      const btn = document.getElementById('reg-btn');
      const originalText = btn.textContent;
      btn.textContent = 'Mendaftar...';
      btn.disabled = true;
      
      const newUser = {
        username,
        password,
        full_name: fullName,
        bio: bio || '',
        profile_emoji: emoji,
        profile_photo: profilePhoto,
        custom_emoji: customEmoji || '',
        created_at: new Date().toISOString()
      };
      
      const result = await window.dataSdk.create(newUser);
      
      btn.textContent = originalText;
      btn.disabled = false;
      
      if (result.isOk) {
        currentUser = { ...newUser };
        changeView('profile');
      } else {
        showInlineError('reg-error', 'Gagal mendaftar, coba lagi');
      }
    }
    
    async function handleLogin(e) {
      e.preventDefault();
      
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      
      errorEl.textContent = '';
      errorEl.classList.add('hidden');
      
      if (!username || !password) {
        showInlineError('login-error', 'Username dan password wajib diisi');
        return;
      }
      
  
